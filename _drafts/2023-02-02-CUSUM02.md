---
title: 02-CUSUM Test
tags:
    - Statistics
    - Stocks
    - Time Series
---

지난 글에서는 CUSUM Test의 이론적 배경에 대해 살펴보았다. 언급했던대로 이번에는 코드 구현을 살펴보도록 하자.

<!--more-->

```python
import numpy as np
import math

class CUSUM:
    """
    This class is for change point detection.
    """
    def __init__(self, data, tol = 1.358):
        """
        Args:
            data (pd.DataFrame): Stock time series.
            tol (float, optional): threshold for rejecting null hypothesis. Defaults to 1.358.
        """
        self.data = data
        self.tol = tol

    def cov_calc(self, h):
        """
        Calculate covariance.

        Args:
            h (int): Cov(Xt,Xt+h)

        Returns:
            float: Covariance.
        """
        n = len(self.data)
        xmean = np.mean(self.data)
        x1 = list(map(lambda x: x - xmean, self.data[:(n - h)]))
        x2 = list(map(lambda x: x - xmean, self.data[h:]))
        return np.dot(x1, x2) / n

    def var_calc(self):  # long run variance
        """
        Calculate variance. This function is based on long run variance.

        Returns:
            float: variance.
        """
        max_h = int(2 ** (0.5 * (math.log10(len(self.data))) ** 2))
        n = len(self.data)
        sd2_hat = self.cov_calc(h=0)
        for i in range(1, max_h + 1):
            sd2_hat += 2 * (1 - i / n) * self.cov_calc(h=i)  # Bartlett kernel
        return sd2_hat

    def CUSUM_calc(self):
        """
        Calculate the test statistics for CUSUM test. This function detects the change of mean.

        Returns:
            int: if we have a change point, its index will be returned.
        """
        n = len(self.data)

        cusum = list(map(lambda x: abs((np.sum(self.data[:x - 1])) - x / n * np.sum(self.data)) / (
                    np.sqrt(n) * np.sqrt(self.var_calc())),
                         list(range(1, n + 1))))

        maxval = max(cusum)
        maxidx = np.argmax(cusum)

        if maxval > 1.358:
            print(f'CUSUM statistics: {maxval}, Change point: {self.data.index[maxidx]}.')
            return self.data.index[maxidx]
        else:
            print('No change.')
            return
```

## \_\_init\_\_



## Reference

* 이상열. (2013). 시계열 분석 이론 및 SAS 실습(pp.142~191). 자유아카데미.